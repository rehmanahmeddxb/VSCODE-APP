{% extends "layout.html" %}
{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h2 class="fw-bold text-warning mb-0"><i class="bi bi-cart-check me-2"></i>Sales</h2>
    <div class="d-flex gap-2 flex-wrap">
        <a href="/" class="btn btn-outline-light btn-sm fw-bold"><i class="bi bi-arrow-left me-1"></i> Back</a>
        <a href="/mixed_transactions" class="btn btn-outline-info btn-sm fw-bold"><i class="bi bi-shuffle me-1"></i> Mixed Report</a>
        <button class="btn btn-warning btn-sm text-dark fw-bold" onclick="openAddSaleModal('Billed')">
            <i class="bi bi-plus-lg"></i> Add Sale
        </button>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-6">
        <div class="card bg-dark border-secondary text-white h-100 shadow-sm" style="cursor: pointer; transition: transform 0.2s;" onclick="openAddSaleModal('Billed')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
            <div class="card-body text-center">
                <h6 class="text-white-50 text-uppercase small fw-bold"><i class="bi bi-receipt me-2"></i>Billed Sales (Credit / Booking)</h6>
                <h2 class="text-info mb-0">{{ stats.billed }}</h2>
                <span class="badge bg-warning text-dark mt-2">Click to Add</span>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card bg-dark border-secondary text-white h-100 shadow-sm" style="cursor: pointer; transition: transform 0.2s;" onclick="openAddSaleModal('Unbilled')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
            <div class="card-body text-center">
                <h6 class="text-white-50 text-uppercase small fw-bold"><i class="bi bi-cash-coin me-2"></i>Unbilled Sales (Cash)</h6>
                <h2 class="text-success mb-0">{{ stats.unbilled }}</h2>
                <span class="badge bg-success text-white mt-2">Click to Add</span>
            </div>
        </div>
    </div>
</div>

<div class="card border-0 shadow-sm" style="background: #1e293b; border: 2px solid #475569 !important; border-radius: 15px; overflow: hidden;">
    <div class="table-responsive">
        <table class="table table-dark table-hover align-middle mb-0">
            <thead style="background: #0f172a;">
                <tr>
                    <th class="fw-bold py-3 ps-4 border-bottom border-secondary text-white-50">Bill No</th>
                    <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Status</th>
                    <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Client</th>
                    <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Product</th>
                    <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Qty</th>
                    <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Total</th>
                    <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Paid</th>
                    <th class="fw-bold py-3 text-end pe-4 border-bottom border-secondary text-white-50">Actions</th>
                </tr>
            </thead>
            <tbody style="background: #1e293b;">
                {% for sale in sales %}
                <tr style="border-bottom: 1px solid #334155; {% if sale.is_void %}opacity: 0.5; text-decoration: line-through;{% endif %}">
                    <td class="ps-4">
                        {% if sale.manual_bill_no %}
                        <a href="/view_bill/{{ sale.manual_bill_no|replace('#', '%23') }}" class="badge bg-dark border border-secondary text-warning text-decoration-none">{{ sale.manual_bill_no }}</a>
                        {% elif sale.invoice %}
                        <a href="/view_bill/{{ sale.invoice.invoice_no|replace('#', '%23') }}" class="badge bg-dark border border-secondary text-info text-decoration-none">{{ sale.invoice.invoice_no }}</a>
                        {% else %}
                        <span class="badge bg-secondary text-white border border-secondary border-opacity-25">CASH-SALE</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if sale.is_void %}
                            <span class="badge bg-danger">VOID</span>
                        {% else %}
                            {% if not sale.manual_bill_no and not sale.invoice_id %}
                            <span class="badge bg-danger-subtle text-danger border border-danger border-opacity-25">UNBILLED</span>
                            {% else %}
                            <span class="badge bg-success-subtle text-success border border-success border-opacity-25">BILLED</span>
                            {% endif %}
                        {% endif %}
                    </td>
                    <td class="text-white">{{ sale.client_name }}</td>
                    <td class="text-white">
                        {% if sale.items %}
                            {{ sale.items[0].product_name }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="text-info fw-bold">
                        {% if sale.items %}
                            {{ sale.items[0].qty }}
                        {% else %}
                            0
                        {% endif %}
                    </td>
                    <td class="text-danger fw-bold">{{ currency_symbol }}{{ "%.2f"|format(sale.amount) }}</td>
                    <td class="text-success fw-bold">{{ currency_symbol }}{{ "%.2f"|format(sale.paid_amount) }}</td>
                    <td class="text-end pe-4">
                        {% if not sale.is_void %}
                        {% if sale.invoice %}
                        <a href="/view_bill/{{ sale.invoice.invoice_no|replace('#', '%23') }}" class="btn btn-outline-info btn-sm border-2 rounded-pill shadow-sm me-1" title="View Invoice"><i class="bi bi-receipt"></i></a>
                        {% elif sale.manual_bill_no %}
                        <a href="/view_bill/{{ sale.manual_bill_no|replace('#', '%23') }}" class="btn btn-outline-info btn-sm border-2 rounded-pill shadow-sm me-1" title="View"><i class="bi bi-eye"></i></a>
                        {% else %}
                        <button class="btn btn-outline-secondary btn-sm border-2 rounded-pill shadow-sm me-1" title="Cash Sale"><i class="bi bi-cash"></i></button>
                        {% endif %}
                        <button type="button" class="btn btn-outline-warning btn-sm border-2 rounded-pill shadow-sm me-1" data-bs-toggle="modal" data-bs-target="#editSaleModal{{ sale.id }}" title="Edit">
                            <i class="bi bi-pencil"></i>
                        </button>
                        {% if current_user.role == 'admin' %}
                        <button class="btn btn-outline-danger btn-sm border-2 rounded-pill shadow-sm me-1" onclick="if(confirm('VOID this sale? Stock will be reversed.')) { document.getElementById('voidSaleForm{{ sale.id }}').submit(); }">Void</button>
                        <form id="voidSaleForm{{ sale.id }}" action="/void_transaction/DirectSale/{{ sale.id }}" method="POST" style="display:none;"></form>
                        {% endif %}
                        {% endif %}
                        <a href="/delete_bill/Sale/{{ sale.id }}" class="btn btn-outline-danger btn-sm border-2 rounded-pill shadow-sm" onclick="return confirm('Delete sale?')"><i class="bi bi-trash"></i></a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="addSaleModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <form class="modal-content border-secondary" style="background: #1e293b;" action="/add_direct_sale" method="POST" enctype="multipart/form-data">
            <div class="modal-header border-0">
                <h5 class="text-warning fw-bold" id="addSaleModalLabel">New Direct Sale</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6 border-end border-secondary">
                        <div class="mb-3 position-relative">
                            <label class="text-white-50 small fw-bold mb-1">1. SELECT CLIENT</label>
                            <div class="input-group" id="clientSearchGroup">
                                <input type="text" name="client_code" id="addSaleClientCode" class="form-control bg-dark text-white border-secondary" placeholder="Search by name or code..." autocomplete="off" required onfocus="showCombobox('addSaleClientCode', 'addSaleCombobox')" oninput="filterCombobox('addSaleClientCode', 'addSaleCombobox', 'addSaleClientNameDisplay'); updateBookingStatus(this.value)" value="{{ client_name_prefill or '' }}">
                                <button class="btn btn-outline-secondary" type="button" onclick="toggleCombobox('addSaleClientCode', 'addSaleCombobox')">
                                    <i class="bi bi-chevron-down text-warning"></i>
                                </button>
                            </div>
                            <input type="hidden" name="client_name" id="addSaleClientNameHidden" value="{{ client_name_prefill or '' }}">
                            <div id="addSaleCombobox" class="combobox-list shadow-lg" style="display: none;">
                                {% for client in clients %}
                                <div class="combobox-item" onclick="selectComboboxItem('addSaleClientCode', 'addSaleCombobox', '{{ client.code }}', '{{ client.name }}', 'addSaleClientNameDisplay'); updateBookingStatus('{{ client.code }}')">
                                    <span class="fw-bold text-warning code-span">{{ client.code }}</span>
                                    <span class="ms-2 text-white-50 small name-span">{{ client.name }}</span>
                                </div>
                                {% endfor %}
                            </div>
                            <div id="addSaleClientNameDisplay" class="text-info small mt-1 fw-bold"></div>
                        </div>
                        <div class="mb-3" id="manualClientNameGroup" style="display:none;">
                            <label class="text-white-50 small fw-bold mb-1">Customer Name (Manual)</label>
                            <input type="text" name="manual_client_name" id="manualClientName" class="form-control bg-dark text-white border-secondary" placeholder="Enter name for unregistered client">
                        </div>
                        <div id="bookingStatusContainer" class="p-3 bg-dark rounded border border-secondary" style="min-height: 200px; overflow-y: auto;">
                            <p class="text-white-50 text-center mt-5">Select a client to see booked items</p>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <label class="text-white-50 small fw-bold mb-1 d-block">2. SALE DETAILS</label>
                        <!-- Hidden category input, managed by JS -->
                        <input type="hidden" name="category" id="saleCategory">
                        <div class="mb-3" id="categorySelectDiv">
                            <label class="text-white-50 small fw-bold mb-1">CATEGORY / CLIENT TYPE</label>
                            <select name="category" id="saleCategory" class="form-select form-select-sm bg-dark text-white border-secondary">
                                <option value="Credit Customer">Credit Sale</option>
                                <option value="Booking Customer">Booking Sale</option>
                                <option value="Mixed Transaction">Mixed Transaction</option>
                                <option value="Cash">Cash Sale</option>
                                {% for cat in categories if cat not in ['Cash', 'Credit Customer', 'Booking Customer'] %}
                                <option value="{{ cat }}">{{ cat }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-check mb-3" id="manualClientToggleDiv" style="display:none;">
                            <input class="form-check-input" type="checkbox" id="manualClientCheck">
                            <label class="form-check-label text-white-50 small" for="manualClientCheck">Unregistered / Manual Client Name</label>
                        </div>
                        <div id="sale-items-container">
                            <div class="compact-item-row mb-3 p-2 rounded border border-secondary bg-dark">
                                <div class="row g-2 align-items-center">
                                    <div class="col-5">
                                        <select name="product_name[]" class="form-select form-select-sm bg-dark text-white border-secondary price-trigger" required>
                                            <option value="">Material</option>
                                            {% for mat in materials %}
                                            <option value="{{ mat.name }}" data-price="{{ mat.unit_price }}">{{ mat.name }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="item-status-badge mt-1"></div>
                                    </div>
                                    <div class="col-4">
                                        <div class="input-group input-group-sm">
                                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeSaleQty(this, -1)">-</button>
                                            <input type="number" step="0.01" name="qty[]" value="1.00" class="form-control bg-dark text-white border-secondary text-center qty-input" required>
                                            <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeSaleQty(this, 1)">+</button>
                                        </div>
                                    </div>
                                    <div class="col-3 position-relative">
                                        <input type="number" step="0.01" name="unit_rate[]" class="form-control form-control-sm bg-dark text-white border-secondary rate-input" placeholder="Rate" required>
                                        <div class="remove-btn position-absolute top-0 end-0 translate-middle-y mt-2" onclick="this.closest('.compact-item-row').remove(); updateSalePrice(this.closest('form'));" style="cursor:pointer; z-index: 5;">
                                            <i class="bi bi-x-circle-fill text-danger"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-warning mb-3 w-100" onclick="addSaleItemRow()">+ Add More Items</button>
                        
                        <div class="mb-3">
                            <label class="text-white-50 small fw-bold mb-1">TOTAL AMOUNT</label>
                            <input type="number" step="0.01" name="amount" id="saleTotal" class="form-control bg-dark text-white border-secondary total-amount" required>
                            <small class="text-white-50 x-small" id="amountHelp">Adjust this amount for mixed booking/credit bills.</small>
                        </div>
                        <div class="mb-3">
                            <label class="text-white-50 small fw-bold mb-1">PAID NOW</label>
                            <input type="number" step="0.01" name="paid_amount" class="form-control bg-dark text-white border-secondary" value="0">
                        </div>
                        <div class="mb-3">
                            <label class="text-white-50 small fw-bold mb-1">MANUAL BILL NO</label>
                            <input type="text" id="addSaleManualBill" name="manual_bill_no" class="form-control bg-dark text-white border-secondary">
                        </div>
                        <div class="form-check mb-3" id="hasBillDiv">
                            <input class="form-check-input" type="checkbox" name="has_bill" id="hasBillCheck" checked>
                            <label class="form-check-label text-white-50" for="hasBillCheck">This transaction has a Bill No</label>
                        </div>
                        <div class="mb-3">
                            <label class="text-white-50 small fw-bold mb-1">BILL PHOTO</label>
                            <input type="file" name="photo" class="form-control bg-dark text-white border-secondary" accept="image/*">
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="create_invoice" id="createInvoiceCheck">
                            <label class="form-check-label text-white-50" for="createInvoiceCheck">Create Invoice for this sale</label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="track_as_cash" id="trackAsCashCheck">
                            <label class="form-check-label text-white-50" for="trackAsCashCheck">Record as Cash Delivery (Track in Pending Bills)</label>
                        </div>
                        {% if not settings or not settings.allow_global_negative_stock %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" name="allow_negative_stock" id="allowNegativeStock">
                            <label class="form-check-label text-danger" for="allowNegativeStock">Allow Negative Stock (Override Limit)</label>
                        </div>
                        {% else %}
                        <div class="alert alert-danger py-2 small mt-3">
                            <i class="bi bi-exclamation-triangle-fill me-1"></i> Global setting for <strong>Negative Stock Override</strong> is active.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 d-flex gap-2">
                <button type="button" class="btn btn-outline-secondary flex-grow-1 py-2 rounded-pill fw-bold" onclick="resetAddSaleForm()">Reset</button>
                <button type="submit" class="btn btn-warning text-dark fw-bold flex-grow-1 py-2 rounded-pill">Save Sale</button>
            </div>
        </form>
    </div>
</div>

{% for sale in sales %}
<div class="modal fade" id="editSaleModal{{ sale.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form class="modal-content border-secondary" style="background: #1e293b;" action="/edit_bill/Sale/{{ sale.id }}" method="POST" enctype="multipart/form-data">
            <div class="modal-header border-0">
                <h5 class="text-warning fw-bold">Edit Sale: {{ sale.manual_bill_no or 'No Bill' }}</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-start">
                <div class="mb-3 position-relative">
                    <label class="text-white-50 small fw-bold mb-1">CLIENT (NAME OR CODE)</label>
                    <div class="input-group">
                        <input type="text" name="client_code" id="editSaleClientCode{{ sale.id }}" value="{{ sale.client_code or '' }}" class="form-control bg-dark text-white border-secondary" placeholder="Search by name or code..." autocomplete="off" required onfocus="showCombobox('editSaleClientCode{{ sale.id }}', 'editSaleCombobox{{ sale.id }}')" oninput="filterCombobox('editSaleClientCode{{ sale.id }}', 'editSaleCombobox{{ sale.id }}', 'editSaleClientNameDisplay{{ sale.id }}')">
                        <button class="btn btn-outline-secondary" type="button" onclick="toggleCombobox('editSaleClientCode{{ sale.id }}', 'editSaleCombobox{{ sale.id }}')">
                            <i class="bi bi-chevron-down text-warning"></i>
                        </button>
                    </div>
                    <div id="editSaleCombobox{{ sale.id }}" class="combobox-list shadow-lg" style="display: none;">
                        {% for client in clients %}
                        <div class="combobox-item" onclick="selectComboboxItem('editSaleClientCode{{ sale.id }}', 'editSaleCombobox{{ sale.id }}', '{{ client.code }}', '{{ client.name }}', 'editSaleClientNameDisplay{{ sale.id }}')">
                            <span class="fw-bold text-warning code-span">{{ client.code }}</span>
                            <span class="ms-2 text-white-50 small name-span">{{ client.name }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    <div id="editSaleClientNameDisplay{{ sale.id }}" class="text-info small mt-1 fw-bold">Name: {{ sale.client_name }}</div>
                </div>

                <div class="items-container-edit">
                    {% for item in sale.items %}
                    <div class="compact-item-row mb-3 p-2 rounded border border-secondary bg-dark">
                        <div class="row g-2 align-items-center">
                            <div class="col-12 mb-2">
                                <select name="product_name[]" class="form-select form-select-sm bg-dark text-white border-secondary price-trigger" required>
                                    {% for mat in materials %}
                                    <option value="{{ mat.name }}" data-price="{{ mat.unit_price }}" {% if mat.name == item.product_name %}selected{% endif %}>{{ mat.name }}</option>
                                    {% endfor %}
                                </select>
                                <div class="item-status-badge mt-1"></div>
                            </div>
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeSaleQty(this, -1)">-</button>
                                    <input type="number" step="0.01" name="qty[]" value="{{ "%.2f"|format(item.qty) }}" class="form-control bg-dark text-white border-secondary text-center qty-input" required>
                                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="changeSaleQty(this, 1)">+</button>
                                </div>
                            </div>
                            <div class="col-6 position-relative">
                                <input type="number" step="0.01" name="unit_rate[]" class="form-control form-control-sm bg-dark text-white border-secondary rate-input" value="{{ item.price_at_time }}" required>
                                <div class="remove-btn position-absolute top-0 end-0 translate-middle-y mt-2" onclick="this.closest('.compact-item-row').remove(); updateSalePrice(this.closest('form'));" style="cursor:pointer; z-index: 5;">
                                    <i class="bi bi-x-circle-fill text-danger"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-sm btn-outline-warning mb-3 w-100" onclick="addSaleItemRowEdit(this)">+ Add More Items</button>

                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="text-white-50 small fw-bold mb-1">TOTAL AMOUNT</label>
                        <input type="number" step="0.01" name="amount" class="form-control bg-dark text-white border-secondary total-amount" value="{{ sale.amount }}" required readonly>
                    </div>
                    <div class="col-6 mb-3">
                        <label class="text-white-50 small fw-bold mb-1">PAID AMOUNT</label>
                        <input type="number" step="0.01" name="paid_amount" class="form-control bg-dark text-white border-secondary" value="{{ sale.paid_amount }}">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">CATEGORY / CLIENT TYPE</label>
                    <select name="category" class="form-select form-select-sm bg-dark text-white border-secondary">
                        <option value="Cash" {% if sale.category == 'Cash' %}selected{% endif %}>Cash Sale (Unregistered)</option>
                        <option value="Credit Customer" {% if sale.category == 'Credit Customer' %}selected{% endif %}>Credit Sale (Ledger)</option>
                        <option value="Booking Customer" {% if sale.category == 'Booking Customer' %}selected{% endif %}>Adjust from Booking</option>
                        <option value="Mixed Transaction" {% if sale.category == 'Mixed Transaction' %}selected{% endif %}>Mixed Transaction</option>
                        {% for cat in categories %}
                            {% if cat not in ['Cash', 'Credit Customer', 'Booking Customer', 'Mixed Transaction'] %}
                            <option value="{{ cat }}" {% if sale.category == cat %}selected{% endif %}>{{ cat }}</option>
                            {% endif %}
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">MANUAL BILL NO</label>
                    <input type="text" id="editSaleManualBill{{ sale.id }}" name="manual_bill_no" class="form-control bg-dark text-white border-secondary" value="{{ sale.manual_bill_no }}">
                </div>
                <div class="form-check mb-3">
                    <input class="form-check-input edit-has-bill-checkbox" type="checkbox" name="has_bill" id="editHasBillCheck{{ sale.id }}" data-target="editSaleManualBill{{ sale.id }}" {% if sale.manual_bill_no %}checked{% endif %}>
                    <label class="form-check-label text-white-50" for="editHasBillCheck{{ sale.id }}">This transaction has a Bill No</label>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">UPDATE PHOTO</label>
                    <input type="file" name="photo" class="form-control bg-dark text-white border-secondary" accept="image/*">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning text-dark fw-bold w-100 py-2 rounded-pill">Save Changes</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<script>
function changeSaleQty(btn, delta) {
    const input = btn.parentElement.querySelector('input');
    let val = parseFloat(input.value) || 0;
    val = Math.max(0, val + delta);
    input.value = val.toFixed(2);
    updateSalePrice(btn.closest('form'));
}

function addSaleItemRow() {
    const container = document.getElementById('sale-items-container');
    const firstRow = container.querySelector('.compact-item-row');
    const newRow = firstRow.cloneNode(true);
    newRow.querySelectorAll('input').forEach(i => {
        if(i.classList.contains('qty-input')) { i.value = '1.00'; }
        else { i.value = ''; }
    });
    newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    container.appendChild(newRow);
    attachSaleListeners(newRow);
}

function addSaleItemRowEdit(btn) {
    const container = btn.previousElementSibling;
    const firstRow = document.querySelector('.compact-item-row');
    const newRow = firstRow.cloneNode(true);
    
    newRow.querySelectorAll('input').forEach(i => {
        if(i.classList.contains('qty-input')) { i.value = '1.00'; }
        else { i.value = ''; }
    });
    newRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
    container.appendChild(newRow);
    attachSaleListeners(newRow);
}

// Global to store booking info
let currentClientBookings = {};

function updateBookingStatus(clientCode) {
    const container = document.getElementById('bookingStatusContainer');
    currentClientBookings = {}; // Reset

    if (!clientCode) {
        container.innerHTML = '<p class="text-white-50 text-center mt-5">Select a client to see booked items</p>';
        return;
    }

    fetch(`/api/client_booking_status/${encodeURIComponent(clientCode)}`)
        .then(res => res.json())
        .then(data => {
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-white-50 text-center mt-5">No bookings found for this client</p>';
                return;
            }
            
            // Store for row logic
            data.forEach(item => {
                if(item.balance > 0) currentClientBookings[item.material] = item.balance;
            });

            // Auto-detect client type: Booking Reserved
            const categorySelect = document.getElementById('saleCategory');
            const hasBookings = Object.keys(currentClientBookings).length > 0;
            
            if (hasBookings && categorySelect) {
                // If client has bookings, default to Booking Customer
                if (categorySelect.value !== 'Booking Customer') {
                    categorySelect.value = 'Booking Customer';
                    categorySelect.dispatchEvent(new Event('change'));
                }
            }

            let html = '<label class="text-warning small fw-bold mb-2">CLIENT BOOKING STATUS</label>';
            data.forEach(item => {
                const colorClass = item.balance > 0 ? 'text-success' : 'text-danger';
                html += `
                <div class="mb-2 p-2 rounded bg-secondary bg-opacity-25 border border-secondary">
                    <div class="d-flex justify-content-between">
                        <span class="text-white small fw-bold">${item.material}</span>
                        <span class="${colorClass} small fw-bold">${item.balance} Left</span>
                    </div>
                    <div class="progress mt-1" style="height: 4px;">
                        <div class="progress-bar bg-warning" style="width: ${item.booked > 0 ? (item.delivered / item.booked * 100) : 0}%"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-1">
                        <span class="text-white-50" style="font-size: 0.7rem;">Booked: ${item.booked}</span>
                        <span class="text-white-50" style="font-size: 0.7rem;">Delivered: ${item.delivered}</span>
                    </div>
                </div>`;
            });
            container.innerHTML = html;
            
            // Re-check all existing rows
            document.querySelectorAll('.compact-item-row').forEach(row => checkItemBookingStatus(row));
        })
        .catch(err => {
            console.error('Error fetching booking status:', err);
            container.innerHTML = '<p class="text-danger text-center mt-5">Error loading status</p>';
        });
}

// Category Change Logic
const saleCategory = document.getElementById('saleCategory');
const manualClientCheck = document.getElementById('manualClientCheck');
const manualToggleDiv = document.getElementById('manualClientToggleDiv');

function updateClientInputVisibility() {
    const manualGroup = document.getElementById('manualClientNameGroup');
    const searchGroup = document.getElementById('clientSearchGroup');
    const clientCodeInput = document.getElementById('addSaleClientCode');

    const isCash = saleCategory.value === 'Cash';
    const isCredit = saleCategory.value === 'Credit Customer';
    const isManualChecked = manualClientCheck.checked;
    const isBooking = saleCategory.value === 'Booking Customer';

    // Re-evaluate all rows for booking status
    document.querySelectorAll('.compact-item-row').forEach(row => checkItemBookingStatus(row));
    
    // Show toggle only for Credit
    manualToggleDiv.style.display = isCredit ? 'block' : 'none';

    if (isCash || (isCredit && isManualChecked)) {
        manualGroup.style.display = 'block';
        searchGroup.style.display = 'none';
        clientCodeInput.removeAttribute('required');
    } else {
        manualGroup.style.display = 'none';
        searchGroup.style.display = 'flex';
        clientCodeInput.setAttribute('required', 'required');
    }
    
    const form = document.querySelector('#addSaleModal form');
    if (form) updateSalePrice(form);
}

if (saleCategory) saleCategory.addEventListener('change', updateClientInputVisibility);
if (manualClientCheck) manualClientCheck.addEventListener('change', updateClientInputVisibility);

function checkItemBookingStatus(row) {
    const select = row.querySelector('.price-trigger');
    const rateInput = row.querySelector('.rate-input');
    const statusBadge = row.querySelector('.item-status-badge');
    
    // Find category input in the same form
    const form = row.closest('form');
    let categoryValue = '';
    if (form) {
        const catInput = form.querySelector('[name="category"]');
        if (catInput) categoryValue = catInput.value;
    }
    
    if (!select || !rateInput) return;
    
    const material = select.value;
    // Check if material is booked for this client
    const balance = currentClientBookings[material] || 0;
    const currentQty = parseFloat(row.querySelector('.qty-input').value) || 0;
    
    if (balance > 0) {
        if (currentQty <= balance) {
            // Fully covered by booking
            rateInput.value = 0;
            rateInput.readOnly = true;
            rateInput.classList.add('text-muted', 'bg-secondary', 'bg-opacity-10');
            if (statusBadge) statusBadge.innerHTML = `<span class="badge bg-warning text-dark" style="font-size: 0.65rem;"><i class="bi bi-bookmark-check me-1"></i>BOOKED (${balance})</span>`;
        } else {
            // Mixed (Partially booked, part sale)
            // Enable price editing for the excess portion
            if (rateInput.readOnly) rateInput.readOnly = false;
            rateInput.classList.remove('text-muted', 'bg-secondary', 'bg-opacity-10');
            rateInput.title = "Enter price for the " + (currentQty - balance).toFixed(2) + " non-booked items (Excess)";
            if (statusBadge) statusBadge.innerHTML = `<span class="badge bg-info text-dark" style="font-size: 0.65rem;">MIXED (Bal: ${balance})</span>`;
        }
    } else {
        // Not booked -> Non-Booked Material
        if (rateInput.readOnly) {
            rateInput.readOnly = false;
            rateInput.classList.remove('text-muted', 'bg-secondary', 'bg-opacity-10');
            rateInput.title = "Enter price for non-booked item";
        }
        if (statusBadge) {
            statusBadge.innerHTML = '<span class="badge bg-info text-dark" style="font-size: 0.65rem;">NON-BOOKED</span>';
        }
    }
    updateSalePrice(form);
}

function attachSaleListeners(row) {
    const select = row.querySelector('.price-trigger');
    const rateInput = row.querySelector('.rate-input');
    const qtyInput = row.querySelector('.qty-input');
    const saleCategory = document.getElementById('saleCategory');
    
    select.addEventListener('change', () => {
        checkItemBookingStatus(row);
    });

    [rateInput, qtyInput].forEach(el => {
        el.addEventListener('input', () => updateSalePrice(row.closest('form')));
    });
    qtyInput.addEventListener('input', () => checkItemBookingStatus(row));
}

function updateSalePrice(form) {
    let total = 0;
    // Clone balance map to track usage across rows (in case multiple rows use same material)
    let tempBalances = {...currentClientBookings};

    form.querySelectorAll('.compact-item-row').forEach(row => {
        const rateInput = row.querySelector('.rate-input');
        const qtyInput = row.querySelector('.qty-input');
        const select = row.querySelector('.price-trigger');

        const price = parseFloat(rateInput.value) || 0;
        const qty = parseFloat(qtyInput.value) || 0;
        const material = select.value;

        let balance = tempBalances[material] || 0;
        let chargeableQty = qty;

        if (balance > 0) {
            if (qty <= balance) {
                chargeableQty = 0; // Fully covered by booking
                tempBalances[material] -= qty;
            } else {
                chargeableQty = qty - balance; // Only charge for excess
                tempBalances[material] = 0;
            }
        }

        total += price * chargeableQty;
    });
    
    const totalInput = form.querySelector('.total-amount');
    // Only auto-update total if it's readonly (Unbilled) or if user hasn't manually edited it (hard to track, so we just update it)
    // Actually for Billed mode, we want to allow override. But usually it sums up.
    // Let's update it, but user can change it after.
    totalInput.value = total.toFixed(2);
    
    // Auto-fill paid amount if Cash Sale
    const cat = document.getElementById('saleCategory').value;
    if (cat === 'Cash') {
        const paidInput = form.querySelector('input[name="paid_amount"]');
        if (paidInput) {
            paidInput.value = total.toFixed(2);
            paidInput.readOnly = true;
        }
    }
}

function openAddSaleModal(mode) {
    const modalEl = document.getElementById('addSaleModal');
    let modal = bootstrap.Modal.getInstance(modalEl);
    if (!modal) {
        modal = new bootstrap.Modal(modalEl);
    }
    
    resetAddSaleForm();
    
    const catSelect = document.getElementById('saleCategory');
    const modalTitle = document.getElementById('addSaleModalLabel');
    const catDiv = document.getElementById('categorySelectDiv');
    const paidInput = document.querySelector('#addSaleModal input[name="paid_amount"]');

    if (catSelect) {
        if (mode === 'Unbilled') {
            catSelect.value = 'Cash';
            modalTitle.innerText = "New Unbilled Sale (Cash)";
            if (paidInput) paidInput.readOnly = true;
            if (catDiv) catDiv.style.display = 'none';
        } else {
            // Billed
            catSelect.value = 'Credit Customer'; // Default for billed
            modalTitle.innerText = "New Billed Sale";
            if (paidInput) paidInput.readOnly = false;
            if (catDiv) catDiv.style.display = 'block';
        }
        catSelect.dispatchEvent(new Event('change'));
    }
    
    updateClientInputVisibility(mode);
    
    modal.show();
}

function resetAddSaleForm() {
    const form = document.querySelector('#addSaleModal form');
    form.reset();

    // Clear Client Search & Display
    const clientCodeInput = document.getElementById('addSaleClientCode');
    const clientNameHidden = document.getElementById('addSaleClientNameHidden');
    const clientNameDisplay = document.getElementById('addSaleClientNameDisplay');
    
    if (clientCodeInput) clientCodeInput.value = '';
    if (clientNameHidden) clientNameHidden.value = '';
    if (clientNameDisplay) clientNameDisplay.innerText = '';

    // Clear Booking Status
    currentClientBookings = {};
    const bookingContainer = document.getElementById('bookingStatusContainer');
    if (bookingContainer) {
        bookingContainer.innerHTML = '<p class="text-white-50 text-center mt-5">Select a client to see booked items</p>';
    }

    // Reset Items (Remove extra rows, reset first row)
    const itemsContainer = document.getElementById('sale-items-container');
    if (itemsContainer) {
        while (itemsContainer.children.length > 1) {
            itemsContainer.removeChild(itemsContainer.lastChild);
        }
        const firstRow = itemsContainer.firstElementChild;
        if (firstRow) {
            firstRow.querySelectorAll('input').forEach(i => {
                if(i.classList.contains('qty-input')) i.value = '1.00';
                else i.value = '';
            });
            firstRow.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
        }
    }

    // Trigger change events to restore UI state (Category visibility, Bill No readonly)
    const hasBillCheck = document.getElementById('hasBillCheck');
    if (hasBillCheck) hasBillCheck.dispatchEvent(new Event('change'));
}

document.addEventListener('DOMContentLoaded', function() {
    // Other client logic...
    document.querySelectorAll('.compact-item-row').forEach(row => attachSaleListeners(row));

    // Toggle manual bill field in Add Sale modal
    const addHasBill = document.getElementById('hasBillCheck');
    const addManual = document.getElementById('addSaleManualBill');
    if (addHasBill && addManual) {
        const setAddState = () => {
            if (addHasBill.checked) {
                addManual.readOnly = false;
                addManual.classList.remove('text-muted');
            } else {
                addManual.value = '';
                addManual.readOnly = true;
                addManual.classList.add('text-muted');
            }
        }
        setAddState();
        addHasBill.addEventListener('change', setAddState);
    }

    // Toggle manual bill for each Edit modal
    document.querySelectorAll('.edit-has-bill-checkbox').forEach(cb => {
        const targetId = cb.dataset.target;
        const manual = document.getElementById(targetId);
        if (!manual) return;
        const setState = () => {
            if (cb.checked) {
                manual.readOnly = false;
                manual.classList.remove('text-muted');
            } else {
                manual.value = '';
                manual.readOnly = true;
                manual.classList.add('text-muted');
            }
        }
        setState();
        cb.addEventListener('change', setState);
    });
});
</script>
{% endblock %}