{% extends "layout.html" %}
{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
    <h2 class="fw-bold text-warning mb-0">Client Ledger</h2>
    <div class="d-flex gap-2 flex-wrap">
        <form class="d-flex gap-2" method="GET" action="{{ url_for('clients') }}">
            <select name="category" class="form-select form-select-sm bg-dark text-white border-secondary" style="width: auto;">
                <option value="">All Categories</option>
                <option value="General" {% if category == 'General' %}selected{% endif %}>General</option>
                <option value="Walking-Customer" {% if category == 'Walking-Customer' %}selected{% endif %}>Walking-Customer</option>
                <option value="Misc" {% if category == 'Misc' %}selected{% endif %}>Misc</option>
            </select>
            <input class="form-control form-control-sm bg-dark text-white border-secondary me-2" type="search" name="search" placeholder="Search Client/Code..." value="{{ search or '' }}">
            <button class="btn btn-outline-warning btn-sm" type="submit">Search</button>
        </form>
        <a href="/export_clients" class="btn btn-outline-success btn-sm fw-bold"><i class="bi bi-file-earmark-excel"></i> Export</a>
        <button class="btn btn-warning btn-sm text-dark fw-bold" data-bs-toggle="modal" data-bs-target="#cModal">+ New Client</button>
    </div>
</div>

<!-- Active Clients Section -->
<div class="mb-5">
    <h4 class="text-info fw-bold mb-3"><i class="bi bi-person-check me-2"></i>Active Clients</h4>
    <div class="card border-0 shadow-sm" style="background: #1e293b; border: 2px solid #475569 !important; border-radius: 15px; overflow: hidden;">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead style="background: #0f172a;">
                    <tr>
                        <th class="fw-bold py-3 ps-4 border-bottom border-secondary text-white-50">Client Name</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Code</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Bills</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Deliveries</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Phone</th>
                        <th class="fw-bold py-3 text-end pe-4 border-bottom border-secondary text-white-50">Actions</th>
                    </tr>
                </thead>
                <tbody style="background: #1e293b;">
                    {% for c in active_pagination.items %}
                    <tr style="border-bottom: 1px solid #334155; background: #1e293b;">
                        <td class="ps-4 py-3">
                            <a href="/ledger/{{ c.id }}" class="text-decoration-none fw-bold text-info fs-5 d-block">{{ c.name }}</a>
                            <span class="badge {% if c.category == 'General' %}bg-primary{% elif c.category == 'Walking-Customer' %}bg-success{% else %}bg-secondary{% endif %} small" style="font-size: 0.65rem;">{{ c.category }}</span>
                        </td>
                        <td><span class="badge bg-dark border border-secondary text-warning">{{ c.code or '---' }}</span></td>
                        <td class="text-info fw-bold">{{ c.total_bills }}</td>
                        <td class="text-warning fw-bold">{{ c.total_deliveries }}</td>
                        <td class="text-white-50">{{ c.phone or '---' }}</td>
                        <td class="text-end pe-4">
                            <button class="btn btn-outline-info btn-sm border-2 rounded-pill shadow-sm me-1" data-bs-toggle="modal" data-bs-target="#transferCModal{{ c.id }}" title="Transfer Data">
                                <i class="bi bi-arrow-right-circle"></i>
                            </button>
                            <button class="btn btn-outline-warning btn-sm border-2 rounded-pill shadow-sm me-1" data-bs-toggle="modal" data-bs-target="#editCModal{{ c.id }}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <a href="/delete_client/{{ c.id }}" class="btn btn-outline-danger btn-sm border-2 rounded-pill shadow-sm" onclick="return confirm('Delete client {{ c.name }}?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if active_pagination.pages > 1 %}
        <div class="card-footer bg-transparent border-0 py-3">
            <nav>
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if active_pagination.has_prev %}
                    <li class="page-item"><a class="page-link bg-dark border-secondary text-warning" href="{{ url_for('clients', page_active=active_pagination.prev_num, search=search) }}">Previous</a></li>
                    {% endif %}
                    <li class="page-item active"><span class="page-link bg-warning border-warning text-dark">{{ active_pagination.page }}</span></li>
                    {% if active_pagination.has_next %}
                    <li class="page-item"><a class="page-link bg-dark border-secondary text-warning" href="{{ url_for('clients', page_active=active_pagination.next_num, search=search) }}">Next</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Inactive Clients Section -->
<div class="mb-5">
    <h4 class="text-secondary fw-bold mb-3"><i class="bi bi-person-x me-2"></i>Inactive Clients</h4>
    <div class="card border-0 shadow-sm" style="background: #0f172a; border: 2px solid #334155 !important; border-radius: 15px; overflow: hidden; opacity: 0.8;">
        <div class="table-responsive">
            <table class="table table-dark table-hover align-middle mb-0">
                <thead style="background: #020617;">
                    <tr>
                        <th class="fw-bold py-3 ps-4 border-bottom border-secondary text-white-50">Client Name</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Code</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Bills</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Deliveries</th>
                        <th class="fw-bold py-3 border-bottom border-secondary text-white-50">Phone</th>
                        <th class="fw-bold py-3 text-end pe-4 border-bottom border-secondary text-white-50">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in inactive_pagination.items %}
                    <tr style="border-bottom: 1px solid #1e293b;">
                        <td class="ps-4 py-3">
                            <span class="fw-bold text-secondary fs-5 d-block text-decoration-line-through">{{ c.name }}</span>
                        </td>
                        <td><span class="badge bg-dark border border-secondary text-secondary">{{ c.code or '---' }}</span></td>
                        <td>
                            <div class="small">
                                <span class="text-secondary d-block">Bills: <strong>{{ c.total_bills }}</strong></span>
                                <span class="text-secondary d-block">Deliveries: <strong>{{ c.total_deliveries }}</strong></span>
                            </div>
                        </td>
                        <td class="text-white-50">{{ c.phone or '---' }}</td>
                        <td class="text-end pe-4">
                            {% if c.transferred_to_id %}
                            <form action="/reclaim_client/{{ c.id }}" method="POST" class="d-inline">
                                <button type="submit" class="btn btn-outline-success btn-sm border-2 rounded-pill shadow-sm me-1" title="Reclaim Data" onclick="return confirm('Reclaim data for {{ c.name }}?')">
                                    <i class="bi bi-arrow-left-circle"></i> Reclaim
                                </button>
                            </form>
                            {% endif %}
                            <a href="/delete_client/{{ c.id }}" class="btn btn-outline-danger btn-sm border-2 rounded-pill shadow-sm" onclick="return confirm('Delete client {{ c.name }}?')">
                                <i class="bi bi-trash"></i>
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% if inactive_pagination.pages > 1 %}
        <div class="card-footer bg-transparent border-0 py-3">
            <nav>
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    {% if inactive_pagination.has_prev %}
                    <li class="page-item"><a class="page-link bg-dark border-secondary text-secondary" href="{{ url_for('clients', page_inactive=inactive_pagination.prev_num, search=search) }}">Previous</a></li>
                    {% endif %}
                    <li class="page-item active"><span class="page-link bg-secondary border-secondary text-white">{{ inactive_pagination.page }}</span></li>
                    {% if inactive_pagination.has_next %}
                    <li class="page-item"><a class="page-link bg-dark border-secondary text-secondary" href="{{ url_for('clients', page_inactive=inactive_pagination.next_num, search=search) }}">Next</a></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

{% for c in active_pagination.items %}
<div class="modal fade" id="editCModal{{ c.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="/edit_client/{{ c.id }}" method="POST" class="modal-content border-secondary" style="background: #1e293b;">
            <div class="modal-header border-0">
                <h5 class="text-warning fw-bold">Edit Client</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">NAME</label>
                    <input type="text" name="name" value="{{ c.name }}" class="form-control bg-dark text-white border-secondary" required>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">CATEGORY</label>
                    <select name="category" class="form-select bg-dark text-white border-secondary">
                        <option value="General" {% if c.category == 'General' %}selected{% endif %}>General</option>
                        <option value="Walking-Customer" {% if c.category == 'Walking-Customer' %}selected{% endif %}>Walking-Customer</option>
                        <option value="Misc" {% if c.category == 'Misc' %}selected{% endif %}>Misc</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">CODE <span class="text-danger">*</span></label>
                    <input type="text" name="code" value="{{ c.code }}" class="form-control bg-dark text-white border-secondary" required>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">PHONE</label>
                    <input type="text" name="phone" value="{{ c.phone }}" class="form-control bg-dark text-white border-secondary">
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">ADDRESS</label>
                    <input type="text" name="address" value="{{ c.address }}" class="form-control bg-dark text-white border-secondary">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning text-dark fw-bold w-100 py-2 rounded-pill">Update Client</button>
            </div>
        </form>
    </div>
</div>

<div class="modal fade" id="transferCModal{{ c.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <form action="/transfer_client/{{ c.id }}" method="POST" class="modal-content border-secondary" style="background: #1e293b;">
            <div class="modal-header border-0">
                <h5 class="text-info fw-bold"><i class="bi bi-arrow-right-circle me-2"></i>Transfer Client Data</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-warning py-2">
                    <i class="bi bi-exclamation-triangle me-1"></i>
                    <strong>Warning:</strong> This will move ALL transaction data from <strong>"{{ c.name }}"</strong> to another client. The source client will become <strong>inactive</strong> and cannot be used again.
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">FROM (Source Client)</label>
                    <input type="text" class="form-control bg-dark text-white border-secondary" value="{{ c.name }} ({{ c.code }})" disabled>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">TO (Target Client) <span class="text-danger">*</span></label>
                    <select name="target_client_id" class="form-select bg-dark text-white border-secondary" required>
                        <option value="">-- Select Target Client --</option>
                        {% for ac in active_clients %}
                        {% if ac.id != c.id %}
                        <option value="{{ ac.id }}">{{ ac.name }} ({{ ac.code }})</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-outline-secondary rounded-pill px-4" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-info text-dark fw-bold rounded-pill px-4" onclick="return confirm('Are you sure? This action cannot be undone.')">Transfer Data</button>
            </div>
        </form>
    </div>
</div>
{% endfor %}

<div class="modal fade" id="cModal" tabindex="-1">
    <div class="modal-dialog">
        <form action="/add_client" method="POST" class="modal-content border-secondary" style="background: #1e293b;">
            <div class="modal-header border-0">
                <h5 class="text-warning fw-bold">Register New Client</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">NAME</label>
                    <input type="text" name="name" class="form-control bg-dark text-white border-secondary" required>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">CATEGORY</label>
                    <select name="category" class="form-select bg-dark text-white border-secondary">
                        <option value="General">General</option>
                        <option value="Walking-Customer">Walking-Customer</option>
                        <option value="Misc">Misc</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">CODE <span class="text-danger">*</span></label>
                    <input type="text" name="code" class="form-control bg-dark text-white border-secondary" required>
                    <small class="text-white-50">Required. Must be unique. Auto-generated only for imports.</small>
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">PHONE</label>
                    <input type="text" name="phone" class="form-control bg-dark text-white border-secondary">
                </div>
                <div class="mb-3">
                    <label class="text-white-50 small fw-bold mb-1">ADDRESS</label>
                    <input type="text" name="address" class="form-control bg-dark text-white border-secondary">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning text-dark fw-bold w-100 py-2 rounded-pill">Create Client</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
