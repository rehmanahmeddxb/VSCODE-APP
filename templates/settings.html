{% extends "layout.html" %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <div>
        <h2 class="fw-bold text-warning mb-0">Settings</h2>
        <p class="text-white-50 small mb-0">System configuration and user management.</p>
    </div>
    <a href="/" class="btn btn-outline-light btn-sm fw-bold"><i class="bi bi-arrow-left me-1"></i> Back</a>
</div>

<div class="row g-3">
    <div class="col-lg-8">
        {% if current_user.role == 'admin' %}
        <div class="card border-secondary bg-dark shadow-sm mb-3" style="border-radius: 12px;">
            <div class="card-header bg-transparent border-secondary py-2">
                <h6 class="fw-bold text-white mb-0"><i class="bi bi-sliders me-2 text-warning"></i>General Settings</h6>
            </div>
            <div class="card-body p-3">
                <form action="{{ url_for('update_settings') }}" method="POST">
                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label class="form-label small text-white-50">Company Name</label>
                            <input type="text" name="company_name" class="form-control form-control-sm bg-dark text-white border-secondary" value="{{ settings.company_name or '' }}">
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label small text-white-50">Currency Symbol</label>
                            <input type="text" name="currency" class="form-control form-control-sm bg-dark text-white border-secondary" value="{{ settings.currency or '' }}">
                        </div>
                    </div>
                    <div class="form-check form-switch mb-3"><input class="form-check-input" type="checkbox" role="switch" name="allow_global_negative_stock" id="globalNegativeStock" {% if settings.allow_global_negative_stock %}checked{% endif %}><label class="form-check-label text-danger small" for="globalNegativeStock">Always Allow Negative Stock</label></div>
                    <button type="submit" class="btn btn-primary btn-sm w-100 fw-bold">Save General Settings</button>
                </form>
            </div>
        </div>
        {% endif %}
        <div class="card border-secondary bg-dark shadow-sm" style="border-radius: 12px;">
            <div class="card-header bg-transparent border-secondary py-2">
                <h6 class="fw-bold text-white mb-0"><i class="bi bi-people me-2 text-warning"></i>User Permissions</h6>
            </div>
            <div class="card-body p-3">
                {% if current_user.role == 'admin' %}
                <button class="btn btn-warning btn-sm fw-bold mb-3" data-bs-toggle="modal" data-bs-target="#addUserModal">+ New User</button>
                {% endif %}
                
                <div class="table-responsive">
                    <table class="table table-dark table-sm align-middle mb-0">
                        <thead class="x-small text-uppercase text-white-50">
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Permissions</th>
                                <th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="small">
                            {% for u in users %}
                            <tr class="border-secondary">
                                <td class="fw-bold">{{ u.username }}</td>
                                <td><span class="badge {{ 'bg-warning text-dark' if u.role == 'admin' else 'bg-secondary' }}">{{ u.role }}</span></td>
                                <td>
                                    <div class="d-flex flex-wrap gap-1">
                                        {% if u.can_view_stock %}<span class="badge bg-dark border border-secondary text-info">Stock</span>{% endif %}
                                        {% if u.can_view_daily %}<span class="badge bg-dark border border-secondary text-success">Daily</span>{% endif %}
                                        {% if u.can_view_history %}<span class="badge bg-dark border border-secondary text-primary">History</span>{% endif %}
                                        {% if u.can_import_export %}<span class="badge bg-dark border border-secondary text-warning">Import</span>{% endif %}
                                        {% if u.can_manage_directory %}<span class="badge bg-dark border border-secondary text-light">Dir</span>{% endif %}
                                    </div>
                                </td>
                                <td class="text-end">
                                    {% if current_user.role == 'admin' and u.username != 'admin' %}
                                    <button class="btn btn-link text-info p-0 me-2" data-bs-toggle="modal" data-bs-target="#editUser{{ u.id }}"><i class="bi bi-shield-check"></i></button>
                                    <a href="/delete_user/{{ u.id }}" class="btn btn-link text-danger p-0" onclick="return confirm('Remove user?')"><i class="bi bi-trash"></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="card border-secondary bg-dark shadow-sm mb-3" style="border-radius: 12px;">
            <div class="card-header bg-transparent border-secondary py-2">
                <h6 class="fw-bold text-white mb-0"><i class="bi bi-key me-2 text-warning"></i>Security</h6>
            </div>
            <div class="card-body p-3">
                <form action="/change_password" method="POST">
                    <div class="input-group input-group-sm">
                        <input type="password" name="password" class="form-control bg-dark text-white border-secondary" placeholder="New Password" required>
                        <button type="submit" class="btn btn-primary fw-bold">Update</button>
                    </div>
                </form>
            </div>
        </div>
        
        {% if current_user.role == 'admin' %}
        <div class="card border-secondary bg-dark shadow-sm mb-3" style="border-radius: 12px;">
            <div class="card-header bg-transparent border-secondary py-2">
                <h6 class="fw-bold text-white mb-0"><i class="bi bi-database-add me-2 text-success"></i>Test Data</h6>
            </div>
            <div class="card-body p-3">
                <p class="text-white-50 x-small mb-2">Generate 500 clients, 20 materials, and random transactions.</p>
                <a href="/generate_dummy_data" class="btn btn-success btn-sm w-100 fw-bold" onclick="return confirm('Generate massive test data? This might take a few seconds.')">Generate Dummy Data</a>
            </div>
        </div>
        {% endif %}

        {% if current_user.role == 'admin' %}
        <div class="card border-0 shadow-sm" style="background: #1e293b; border: 2px solid #ef4444 !important; border-radius: 15px;">
            <div class="card-header bg-transparent border-danger py-2">
                <h6 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>Granular Data Wipe</h6>
            </div>
            <div class="card-body p-3">
                <p class="text-white-50 x-small mb-3">Select datasets to clear. Action is irreversible.</p>
                <form action="{{ url_for('delete_selected_data') }}" method="POST">
                    <div class="row g-2 mb-3">
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="clients" id="wipeClients"><label class="form-check-label text-white" for="wipeClients">Clients</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="pending_bills" id="wipeBills"><label class="form-check-label text-white" for="wipeBills">Pending Bills</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="dispatching" id="wipeDispatch"><label class="form-check-label text-white" for="wipeDispatch">Dispatch (OUT)</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="receiving" id="wipeReceive"><label class="form-check-label text-white" for="wipeReceive">Receive (IN)</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="materials" id="wipeMaterials"><label class="form-check-label text-white" for="wipeMaterials">Materials</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="direct_sales" id="wipeDirectSales"><label class="form-check-label text-white" for="wipeDirectSales">Direct Sales</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="payments" id="wipePayments"><label class="form-check-label text-white" for="wipePayments">Payments</label></div></div>
                        <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="delete_targets" value="bookings" id="wipeBookings"><label class="form-check-label text-white" for="wipeBookings">Bookings</label></div></div>
                    </div>

                    <button type="button" id="openWipeModal" class="btn btn-danger btn-sm w-100 fw-bold" data-bs-toggle="modal" data-bs-target="#wipeConfirmModal">Wipe Selected</button>
                
                </form>

                <!-- Wipe confirmation modal -->
                <div class="modal fade" id="wipeConfirmModal" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <form id="wipeConfirmForm" class="modal-content border-danger bg-dark text-white" action="{{ url_for('delete_selected_data') }}" method="POST">
                            <div class="modal-header border-danger py-2">
                                <h6 class="fw-bold mb-0 text-danger">Confirm Data Wipe</h6>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <p class="text-white-50 small">You are about to permanently delete the following datasets:</p>
                                <ul id="selectedDatasetsList" class="text-white small mb-3"></ul>
                                <div class="mb-2">
                                    <input type="text" id="modal_confirm_text" name="confirm_text" class="form-control form-control-sm bg-dark text-white border-danger" placeholder="Type DELETE SELECTED to confirm" required>
                                </div>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="checkbox" id="ackCheck"><label class="form-check-label text-white-50" for="ackCheck">I understand this action is irreversible</label>
                                </div>
                            </div>
                            <div class="modal-footer border-0">
                                <button type="submit" id="modal_submit_btn" class="btn btn-danger w-100 fw-bold" disabled>Confirm Wipe</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals -->
{% if current_user.role == 'admin' %}
<div class="modal fade" id="addUserModal" tabindex="-1">

<!-- Wipe modal client-side script -->
<script>
document.addEventListener('DOMContentLoaded', function(){
    const openBtn = document.getElementById('openWipeModal');
    if (openBtn) {
        openBtn.addEventListener('click', function(e){
            const checked = Array.from(document.querySelectorAll('input[name="delete_targets"]:checked'));
            if (!checked.length) {
                alert('Please select at least one dataset to wipe');
                e.preventDefault();
                return;
            }
            const list = document.getElementById('selectedDatasetsList');
            list.innerHTML = '';
            const form = document.getElementById('wipeConfirmForm');
            // remove previous hidden inputs
            form.querySelectorAll('input[name="delete_targets"]').forEach(n => n.remove());
            checked.forEach(c => {
                const lbl = document.querySelector('label[for="' + c.id + '"]');
                const labelText = lbl ? lbl.innerText.trim() : c.value;
                const li = document.createElement('li'); li.innerText = labelText; list.appendChild(li);
                const hidden = document.createElement('input'); hidden.type='hidden'; hidden.name='delete_targets'; hidden.value=c.value; form.appendChild(hidden);
            });
            document.getElementById('modal_confirm_text').value='';
            document.getElementById('ackCheck').checked=false;
            document.getElementById('modal_submit_btn').disabled=true;
        });

        function checkModalEnable(){
            const confirmed = document.getElementById('modal_confirm_text').value === 'DELETE SELECTED';
            const acked = document.getElementById('ackCheck').checked;
            document.getElementById('modal_submit_btn').disabled = !(confirmed && acked);
        }
        document.getElementById('modal_confirm_text').addEventListener('input', checkModalEnable);
        document.getElementById('ackCheck').addEventListener('change', checkModalEnable);
    }
});
</script>
    <div class="modal-dialog modal-dialog-centered">
        <form action="/add_user" method="POST" class="modal-content border-secondary bg-dark text-white">
            <div class="modal-header border-secondary py-2">
                <h6 class="fw-bold mb-0">Create User</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" name="username" class="form-control bg-dark text-white border-secondary" placeholder="Username" required>
                </div>
                <div class="mb-3">
                    <input type="password" name="password" class="form-control bg-dark text-white border-secondary" placeholder="Password" required>
                </div>
                <div class="mb-3">
                    <select name="role" class="form-select bg-dark text-white border-secondary">
                        <option value="user">Standard User</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>
                <h6 class="small fw-bold text-warning text-uppercase mb-2">Module Access</h6>
                <div class="row g-2">
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_stock" checked> <label>Stock Summary</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_daily" checked> <label>Daily Breakdown</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_history" checked> <label>History/Search</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_import_export"> <label>Import/Export</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_manage_directory"> <label>Client/Material</label></div></div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning w-100 fw-bold">Create Account</button>
            </div>
        </form>
    </div>
</div>

{% for u in users %}
{% if u.username != 'admin' %}
<div class="modal fade" id="editUser{{ u.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/edit_user_permissions/{{ u.id }}" method="POST" class="modal-content border-secondary bg-dark text-white">
            <div class="modal-header border-secondary py-2">
                <h6 class="fw-bold mb-0">Edit Permissions: {{ u.username }}</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="x-small text-white-50">Role</label>
                    <select name="role" class="form-select bg-dark text-white border-secondary">
                        <option value="user" {{ 'selected' if u.role == 'user' }}>Standard User</option>
                        <option value="admin" {{ 'selected' if u.role == 'admin' }}>Administrator</option>
                    </select>
                </div>
                <h6 class="small fw-bold text-warning text-uppercase mb-2">Module Access</h6>
                <div class="row g-2">
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_stock" {{ 'checked' if u.can_view_stock }}> <label>Stock Summary</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_daily" {{ 'checked' if u.can_view_daily }}> <label>Daily Breakdown</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_view_history" {{ 'checked' if u.can_view_history }}> <label>History/Search</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_import_export" {{ 'checked' if u.can_import_export }}> <label>Import/Export</label></div></div>
                    <div class="col-6"><div class="form-check small"><input class="form-check-input" type="checkbox" name="can_manage_directory" {{ 'checked' if u.can_manage_directory }}> <label>Client/Material</label></div></div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="submit" class="btn btn-warning w-100 fw-bold">Update Permissions</button>
            </div>
        </form>
    </div>
</div>
{% endif %}
{% endfor %}
{% endif %}
{% endblock %}
