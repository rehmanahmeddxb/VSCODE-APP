{% extends "layout.html" %}
{% block content %}
<style>
    .entry-table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    .entry-table {
        min-width: 1000px;
    }
    .entry-table th, .entry-table td {
        white-space: nowrap;
        vertical-align: middle;
    }
    .action-cell {
        position: sticky;
        right: 0;
        background: #1e293b;
        z-index: 1;
    }
    thead .action-cell {
        background: #0f172a;
    }
    .action-btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 14px;
        font-weight: 600;
        border-radius: 50px;
        gap: 5px;
    }
    @media (max-width: 576px) {
        .entry-table {
            min-width: 900px;
        }
        .action-btn {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        .search-box {
            width: 100% !important;
        }
    }
</style>

<div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-2">
    <h2 class="fw-bold text-warning mb-0">History & Search</h2>
</div>

<div class="card border-0 shadow-sm mb-4" style="background: #1e293b; border: 2px solid #475569 !important; border-radius: 15px;">

<div class="card border-0 shadow-sm mb-4" style="background: #1e293b; border: 2px solid #475569 !important; border-radius: 15px;">
    <div class="card-body p-3 p-md-4">
        <h6 class="fw-bold mb-3 text-warning"><i class="bi bi-filter-square me-2"></i>Advanced Filter</h6>
        <form method="GET" class="row g-3 align-items-end">
            <div class="col-6 col-md-2">
                <label class="small fw-bold text-white-50">From</label>
                <input type="date" name="start_date" value="{{ start_date }}" class="form-control bg-dark text-white border-secondary">
            </div>
            <div class="col-6 col-md-2">
                <label class="small fw-bold text-white-50">To</label>
                <input type="date" name="end_date" value="{{ end_date }}" class="form-control bg-dark text-white border-secondary">
            </div>
            <div class="col-6 col-md-2">
                <label class="small fw-bold text-white-50">Type</label>
                <select name="type" class="form-select bg-dark text-white border-secondary">
                    <option value="">All</option>
                    <option value="IN" {% if type_filter == 'IN' %}selected{% endif %}>IN (Receiving)</option>
                    <option value="OUT" {% if type_filter == 'OUT' %}selected{% endif %}>OUT (Dispatch)</option>
                    <option value="BOOKING" {% if type_filter == 'BOOKING' %}selected{% endif %}>BOOKING (Reserved)</option>
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="small fw-bold text-white-50">Has Bill</label>
                <select name="has_bill" class="form-select bg-dark text-white border-secondary">
                    <option value="">Any</option>
                    <option value="1" {% if has_bill_filter == '1' %}selected{% endif %}>With Bill</option>
                    <option value="0" {% if has_bill_filter == '0' %}selected{% endif %}>Without Bill</option>
                </select>
            </div>
            <div class="col-6 col-md-3">
                <label class="small fw-bold text-white-50 text-uppercase mb-1">Client</label>
                <div class="position-relative">
                    <input type="text" name="client" id="clientFilterSearch" value="{{ client_filter or '' }}" class="form-control bg-dark text-white border-secondary" placeholder="Type to filter..." autocomplete="off">
                    <div id="filterSuggestions" class="list-group position-absolute w-100 shadow-lg" style="z-index: 1000; display: none;"></div>
                </div>
            </div>
            <div class="col-6 col-md-3">
                <label class="small fw-bold text-white-50">Material</label>
                <select name="material" class="form-select bg-dark text-white border-secondary">
                    <option value="">All Brands</option>
                    {% for m in materials %}
                    <option value="{{ m.name }}" {{ 'selected' if material_filter == m.name }}>{{ m.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-6 col-md-2">
                <label class="small fw-bold text-white-50">Bill No</label>
                <input type="text" name="bill_no" value="{{ bill_no_filter or '' }}" class="form-control bg-dark text-white border-secondary" placeholder="Search Bill No...">
            </div>
            <div class="col-6 col-md-2">
                <label class="small fw-bold text-white-50">Category</label>
                <select name="category" class="form-select bg-dark text-white border-secondary">
                    <option value="">All Categories</option>
                    <option value="General" {% if category_filter == 'General' %}selected{% endif %}>General</option>
                    <option value="Walking-Customer" {% if category_filter == 'Walking-Customer' %}selected{% endif %}>Walking-Customer</option>
                    <option value="Misc" {% if category_filter == 'Misc' %}selected{% endif %}>Misc</option>
                </select>
            </div>
            <div class="col-12 col-md-2">
                <button type="submit" class="btn btn-primary w-100 fw-bold shadow-sm">Filter</button>
            </div>
        </form>
    </div>
</div>

{% if has_filter %}
<div class="card border-0 shadow-sm mb-4" style="background: #1e293b; border: 2px solid #475569 !important; border-radius: 15px;">
    <div class="card-header bg-transparent border-secondary p-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2">
            <div class="flex-grow-1">
                <form method="GET" class="d-flex gap-2">
                    <input type="hidden" name="start_date" value="{{ start_date }}">
                    <input type="hidden" name="end_date" value="{{ end_date }}">
                    <input type="hidden" name="client" value="{{ client_filter }}">
                    <input type="hidden" name="material" value="{{ material_filter }}">
                    <input type="hidden" name="category" value="{{ category_filter }}">
                    <input type="text" name="search" value="{{ search_query }}" class="form-control bg-dark text-white border-secondary search-box" style="max-width: 250px;" placeholder="Search in results...">
                    <button type="submit" class="btn btn-outline-warning btn-sm"><i class="bi bi-search"></i></button>
                </form>
            </div>
            <div class="text-end">
                <span class="text-white-50 small fw-bold">TOTAL BAGS:</span>
                <span class="h5 text-warning fw-bold mb-0 ms-2">{{ total_qty|int }}</span>
                <div class="small text-success fw-bold">
                    {% for mat, q in summary.items() %}
                        {{ mat }}: {{ q|int }}{{ " | " if not loop.last }}
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    <div class="entry-table-wrapper">
        <table class="table table-dark table-hover mb-0 align-middle entry-table" id="trackTable">
            <thead class="small text-uppercase" style="background: #0f172a;">
                <tr>
                    <th class="ps-3 text-white-50">Date</th>
                    <th class="text-white-50">Time</th>
                    <th class="text-white-50">Type</th>
                    <th class="text-white-50">Client</th>
                    <th class="text-white-50">Code</th>
                    <th class="text-white-50">Material</th>
                    <th class="text-white-50">Qty</th>
                    <th class="text-white-50">Auto Bill</th>
                    <th class="text-white-50">Manual Bill</th>
                    <th class="text-white-50">Nimbus No</th>
                    <th class="text-white-50">By</th>
                    <th class="text-end pe-3 text-white-50 action-cell">Action</th>
                </tr>
            </thead>
            <tbody>
                {% for e in entries %}
                <tr style="border-bottom: 1px solid #334155;">
                    <td class="ps-3 fw-bold text-warning">{{ e.date }}</td>
                    <td class="text-white-50">{{ e.time }}</td>
                    <td>
                        {% if e.type == 'IN' %}
                        <span class="badge bg-success px-3 py-2 rounded-pill fw-bold">IN</span>
                        {% elif e.type == 'OUT' %}
                        <span class="badge bg-info text-dark px-3 py-2 rounded-pill fw-bold">OUT</span>
                        {% elif e.type == 'BOOKING' %}
                        <span class="badge bg-warning text-dark px-3 py-2 rounded-pill fw-bold">BOOKING</span>
                        {% else %}
                        <span class="badge bg-secondary px-3 py-2 rounded-pill fw-bold">{{ e.type }}</span>
                        {% endif %}
                    </td>
                    <td class="fw-bold text-white">{{ e.client or '---' }}</td>
                    <td class="text-white-50 small">{{ e.client_code or '---' }}</td>
                    <td class="material-name text-warning fw-bold">{{ e.material }}</td>
                    <td class="qty-val fw-bold {{ 'text-success' if e.type == 'IN' else ( 'text-info' if e.type == 'OUT' else 'text-warning') }} fs-5">
                        {{ '+' if e.type == 'IN' else '-' }}{{ e.qty|int }}
                    </td>
                    <td>
                        {% if e.auto_bill_no and e.auto_bill_no != '---' %}
                        <a href="/pending_bills?bill_no={{ e.auto_bill_no }}" class="badge bg-dark border border-secondary text-warning text-decoration-none">{{ e.auto_bill_no }}</a>
                        {% else %}
                        <span class="text-white-50 small">---</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if e.bill_no and e.bill_no != '---' %}
                        <a href="/pending_bills?bill_no={{ e.bill_no }}" class="badge bg-dark border border-secondary text-warning text-decoration-none">{{ e.bill_no }}</a>
                        {% else %}
                        <span class="text-white-50 small text-muted">(empty)</span>
                        {% endif %}
                    </td>
                    <td class="text-white-50">{{ e.nimbus_no or '---' }}</td>
                    <td class="text-info small fw-bold">{{ e.created_by or 'System' }}</td>
                    <td class="text-end pe-3 action-cell">
                        {% set today_str = now_date %}
                        {% if e.type == 'BOOKING' %}
                        <a href="/bookings?search={{ e.bill_no or '' }}" class="btn btn-outline-info action-btn me-1">
                            <i class="bi bi-journal-bookmark me-1"></i> View Booking
                        </a>
                        {% else %}
                            {% if current_user.role == 'admin' or e.date == today_str %}
                            <button class="btn btn-warning action-btn text-dark me-1" data-bs-toggle="modal" data-bs-target="#editTrack{{ e.id }}">
                                <i class="bi bi-pencil-fill"></i> Edit
                            </button>
                            {% else %}
                            <span class="badge bg-secondary opacity-50"><i class="bi bi-lock"></i> Locked</span>
                            {% endif %}
                        {% endif %}
                    </td>
                </tr>
                
                {% if e.type != 'BOOKING' %}
                <div class="modal fade" id="editTrack{{ e.id }}" tabindex="-1">
                    <div class="modal-dialog modal-lg modal-dialog-centered">
                        <div class="modal-content border-secondary shadow-lg" style="background: #1e293b; border-radius: 15px;">
                            <form action="/edit_entry/{{ e.id }}" method="POST">
                                <input type="hidden" name="redirect_to" value="tracking">
                                <div class="modal-header border-0">
                                    <h5 class="text-warning fw-bold">Edit Entry</h5>
                                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body pt-0">
                                    <div class="mb-3">
                                        <small class="text-white-50">Captured By: <span class="text-warning fw-bold">{{ e.created_by or 'System' }}</span></small>
                                    </div>
                                    <div class="row g-3">
                                        <div class="col-md-4 col-6">
                                            <label class="form-label small fw-bold text-uppercase text-white">Date</label>
                                            <input type="date" name="date" value="{{ e.date }}" class="form-control bg-dark text-white border-secondary" required>
                                        </div>
                                        <div class="col-md-4 col-6">
                                            <label class="form-label small fw-bold text-uppercase text-white">Time</label>
                                            <input type="time" name="time" value="{{ e.time }}" class="form-control bg-dark text-white border-secondary">
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold text-uppercase text-white">Type</label>
                                            <select name="type" class="form-select bg-dark text-white border-secondary">
                                                <option value="IN" {{ 'selected' if e.type == 'IN' }}>IN (Receiving)</option>
                                                <option value="OUT" {{ 'selected' if e.type == 'OUT' }}>OUT (Dispatch)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-uppercase text-white">Material Brand</label>
                                            <select name="material" class="form-select bg-dark text-white border-secondary" required>
                                                {% for m in materials %}
                                                <option value="{{ m.name }}" {{ 'selected' if e.material == m.name }}>{{ m.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small fw-bold text-uppercase text-white">Client</label>
                                            <select name="client" class="form-select bg-dark text-white border-secondary">
                                                <option value="">-- None (Receiving) --</option>
                                                {% for c in clients %}
                                                <option value="{{ c.name }}" {{ 'selected' if e.client == c.name }}>{{ c.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="row g-3 mt-2">
                                        <div class="col-md-4 col-6">
                                            <label class="form-label small fw-bold text-uppercase text-white">Quantity</label>
                                            <input type="number" name="qty" value="{{ e.qty|int }}" class="form-control bg-dark text-white border-secondary fs-5 fw-bold" required>
                                        </div>
                                        <div class="col-md-4 col-6">
                                            <label class="form-label small fw-bold text-uppercase text-white">Bill No</label>
                                            <input type="text" name="bill_no" value="{{ e.bill_no or '' }}" class="form-control bg-dark text-white border-secondary">
                                        </div>
                                        <div class="col-md-4 col-12">
                                            <label class="form-label small fw-bold text-uppercase text-white">Nimbus No</label>
                                            <input type="text" name="nimbus_no" value="{{ e.nimbus_no or '' }}" class="form-control bg-dark text-white border-secondary">
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer border-0 pt-0 d-flex flex-wrap {{ 'justify-content-between' if current_user.role == 'admin' else 'justify-content-end' }} gap-2">
                                    {% if current_user.role == 'admin' %}
                                    <a href="/delete_entry/{{ e.id }}" class="btn btn-outline-danger px-4 fw-bold rounded-pill" onclick="return confirm('Permanent Delete?')">
                                        <i class="bi bi-trash me-1"></i> Delete
                                    </a>
                                    {% endif %}
                                    <button type="submit" class="btn btn-warning px-5 fw-bold rounded-pill shadow text-dark">
                                        Update Record
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- Pagination UI -->
    {% if pagination and pagination.pages > 1 %}
    <div class="card-footer bg-transparent border-secondary p-3">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                    <a class="page-link bg-dark text-white border-secondary" href="{{ url_for('tracking', page=pagination.prev_num, start_date=start_date, end_date=end_date, client=client_filter, material=material_filter, category=category_filter, search=search_query) if pagination.has_prev else '#' }}">Previous</a>
                </li>
                
                <li class="page-item active">
                    <span class="page-link bg-warning text-dark border-warning fw-bold">Page {{ pagination.page }} of {{ pagination.pages }}</span>
                </li>

                <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                    <a class="page-link bg-dark text-white border-secondary" href="{{ url_for('tracking', page=pagination.next_num, start_date=start_date, end_date=end_date, client=client_filter, material=material_filter, category=category_filter, search=search_query) if pagination.has_next else '#' }}">Next</a>
                </li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
{% else %}
<div class="card border-0 shadow-sm mb-4" style="background: #1e293b; border: 2px solid #475569 !important; border-radius: 15px;">
    <div class="card-body text-center py-5">
        <i class="bi bi-search display-1 text-warning mb-3"></i>
        <h4 class="text-white fw-bold mb-3">Search Entries</h4>
        <p class="text-white-50 mb-0">Use the filter options above to find transactions.</p>
        <p class="text-white-50">Select a date range, client, material, or use the search box.</p>
    </div>
</div>
{% endif %}

<script>
    const filterInput = document.getElementById('clientFilterSearch');
    const filterSuggs = document.getElementById('filterSuggestions');

    if (filterInput) {
        filterInput.addEventListener('input', async (e) => {
            const val = e.target.value;
            if (val.length < 1) {
                filterSuggs.style.display = 'none';
                return;
            }

            const resp = await fetch(`/api/clients/search?q=${val}`);
            const data = await resp.json();

            if (data.length > 0) {
                filterSuggs.innerHTML = data.map(c => `
                    <button type="button" class="list-group-item list-group-item-action bg-dark text-white border-secondary py-2" onclick="selectFilterClient('${c.name}')">
                        <div class="fw-bold text-warning">${c.name}</div>
                        <small class="text-white-50">${c.code || 'No Code'}</small>
                    </button>
                `).join('');
                filterSuggs.style.display = 'block';
            } else {
                filterSuggs.style.display = 'none';
            }
        });
    }

    function selectFilterClient(name) {
        filterInput.value = name;
        filterSuggs.style.display = 'none';
    }

    document.addEventListener('click', (e) => {
        if (filterInput && !filterInput.contains(e.target) && !filterSuggs.contains(e.target)) {
            filterSuggs.style.display = 'none';
        }
    });
</script>
{% endblock %}
